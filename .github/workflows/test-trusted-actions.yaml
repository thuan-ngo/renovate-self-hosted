name: Test Trusted Actions

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  # Test actions/* pattern - Official GitHub Actions
  test-official-actions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4.4.0
        with:
          node-version: '20'
      
      - name: Verify Node.js
        run: |
          node --version
          npm --version
      
      - name: Setup Python
        uses: actions/setup-python@v5.6.0
        with:
          python-version: '3.11'
      
      - name: Verify Python
        run: |
          python --version
          pip --version
      
      - name: Setup Go
        uses: actions/setup-go@v5.5.0
        with:
          go-version: '1.21'
      
      - name: Verify Go
        run: go version
      
      - name: Cache dependencies
        uses: actions/cache@v4.3.0
        with:
          path: ~/.cache
          key: test-cache-${{ runner.os }}
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4.6.2
        with:
          name: test-artifact
          path: README.md
      
      - name: Download artifact
        uses: actions/download-artifact@v4.3.0
        continue-on-error: true
        with:
          name: test-artifact
      
      - name: GitHub Script
        uses: actions/github-script@v7.1.0
        with:
          script: |
            console.log('âœ… GitHub Script test passed');
      
      - name: Test result
        run: echo "âœ… Official GitHub Actions test passed"

  # Test aws-actions/* pattern - AWS Actions
  test-aws-actions:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.1
      
      - name: Configure AWS credentials (mock)
        uses: aws-actions/configure-aws-credentials@v4.3.1
        continue-on-error: true
        with:
          role-to-assume: arn:aws:iam::123456789012:role/test-role
          aws-region: ap-northeast-1
      
      - name: Amazon ECR Login (mock)
        uses: aws-actions/amazon-ecr-login@v2.0.1
        continue-on-error: true
      
      - name: Test result
        run: echo "âœ… AWS Actions test passed"

  # Test docker/* pattern - Docker Actions  
  test-docker-actions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.1
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3.0.0
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.11.1
      
      - name: Verify Docker Buildx
        run: |
          docker buildx version
          docker buildx ls
      
      - name: Docker Login (mock)
        uses: docker/login-action@v3.6.0
        continue-on-error: true
        with:
          username: test
          password: test
      
      - name: Docker Metadata
        uses: docker/metadata-action@v5.9.0
        with:
          images: test/image
      
      - name: Create test Dockerfile
        run: |
          cat > Dockerfile.test << 'EOF'
          FROM alpine:3.19
          RUN echo "Test image for Renovate"
          CMD ["echo", "Hello from test container"]
          EOF
      
      - name: Build test image
        uses: docker/build-push-action@v5.4.0
        with:
          context: .
          file: ./Dockerfile.test
          push: false
          tags: test:latest
      
      - name: Test result
        run: echo "âœ… Docker Actions test passed"

  # Test ruby/* pattern - Ruby Actions
  test-ruby-actions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.1
      
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1.269.0
        with:
          ruby-version: '3.2'
          bundler-cache: false
      
      - name: Test Ruby version
        run: |
          ruby --version
          gem --version
      
      - name: Test result
        run: echo "âœ… Ruby Actions test passed"

  # Test cybozu* pattern - Internal Cybozu Actions (mock - will use echo for now)
  test-cybozu-actions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.1
      
      - name: Mock Cybozu action
        run: |
          echo "ðŸ”· Testing pattern: ^cybozu"
          echo "ðŸ”· Examples:"
          echo "   â€¢ cybozu/action-name"
          echo "   â€¢ cybozu-cli/some-action"
          echo "   â€¢ cybozu-ept/another-action"
          echo ""
          echo "âœ… Cybozu Actions pattern test passed"

  test-third-party-pinned:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.1
      
      - name: JFrog CLI (third-party)
        uses: jfrog/setup-jfrog-cli@v4.5.8
        continue-on-error: true
      
      - name: Gradle Build Action (third-party)
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5.0.0
        continue-on-error: true
      
      - name: Snyk Security (third-party)
        uses: snyk/actions/setup@0.4.0
        continue-on-error: true
      
      - name: Test result
        run: |
          echo "================================================"
          echo "âœ… Third-party Actions (pinDigests) Test Passed!"
          echo "================================================"
          echo ""
          echo "These actions are NOT in trusted list:"
          echo "  â€¢ jfrog/setup-jfrog-cli"
          echo "  â€¢ gradle/actions/setup-gradle"
          echo "  â€¢ snyk/actions/setup"
          echo ""
          echo "Expected Renovate behavior:"
          echo "  â€¢ pinDigests: true"
          echo "  â€¢ automerge: false"
          echo "================================================"

  test-summary:
    runs-on: ubuntu-latest
    needs: 
      - test-official-actions
      - test-aws-actions
      - test-docker-actions
      - test-ruby-actions
      - test-cybozu-actions
      - test-third-party-pinned
    steps:
      - name: Test Summary
        run: |
          echo "================================================"
          echo "âœ… All Package Rules Tests Passed!"
          echo "================================================"
          echo ""
          echo "TRUSTED ACTIONS (auto-merge minor/patch):"
          echo "  â€¢ actions/*      (Official GitHub Actions)"
          echo "  â€¢ aws-actions/*  (AWS Official Actions)"
          echo "  â€¢ docker/*       (Docker Official Actions)"
          echo "  â€¢ ruby/*         (Ruby Official Actions)"
          echo "  â€¢ cybozu*        (Internal Cybozu Actions)"
          echo ""
          echo "THIRD-PARTY ACTIONS (pinDigests, no automerge):"
          echo "  â€¢ jfrog/*"
          echo "  â€¢ gradle/*"
          echo "  â€¢ snyk/*"
          echo "  â€¢ codecov/*"
          echo "  â€¢ slackapi/*"
          echo "  â€¢ sonarsource/*"
          echo ""
          echo "DISABLED UPDATES:"
          echo "  â€¢ mysql (Docker service)"
          echo "  â€¢ node, java, python (runtime versions)"
          echo ""
          echo "Expected Renovate behavior:"
          echo "  â€¢ Trusted Minor/Patch  â†’ Auto-merge âœ…"
          echo "  â€¢ Trusted Major        â†’ Manual review â¸ï¸"
          echo "  â€¢ Third-party          â†’ Manual + pinDigests ðŸ“Œ"
          echo "  â€¢ Disabled             â†’ No PRs created âŒ"
          echo "================================================"

