name: Renovate

on:
  workflow_dispatch:
    inputs:
      log-level:
        description: renovate log
        type: choice
        options:
          - debug
          - info
        default: info
  schedule:
    - cron: '*/30 * * * *'

concurrency: renovate

permissions:
  contents: read

jobs:
  renovate:
    runs-on: [ self-hosted ]
    strategy:
      matrix:
        branch: [main, dev1, dev2]
    steps:
      - name: Generate GitHub Apps token
        id: generate-github-app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}

      - name: Run self-hosted Renovate
        uses: renovatebot/github-action@a3c115cd6676c8a5bc72f9715f108759e570daf5 # v43.0.19
        with:
          configurationFile: renovate.json5
          token: ${{ steps.generate-github-app-token.outputs.token }}
          renovate-version: 41.116.7
        env:
          RENOVATE_REPOSITORIES: ${{ github.repository }}
          RENOVATE_BASE_BRANCHES: ${{ matrix.branch }}
          RENOVATE_LOG_LEVEL: ${{ github.event.inputs.log-level || 'info' }}
          LOG_LEVEL: ${{ github.event.inputs.log-level || 'info' }}

      - name: Setup pnpm for notification
        if: always()
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.1

      - name: Setup Node.js for notification
        if: always()
        uses: actions/setup-node@v4
        with:
          node-version: '24.11.1'
          cache: 'pnpm'
          cache-dependency-path: .github/actions/notify-renovate-to-kintone/pnpm-lock.yaml

      - name: Install dependencies
        if: always()
        working-directory: .github/actions/notify-renovate-to-kintone
        run: pnpm install --frozen-lockfile


      # PRIMARY PURPOSE: Ensure all open Renovate PRs have records in Kintone
      # This is the main mechanism to guarantee data completeness
      # Event-driven notifications (renovate-pr-notification.yaml) are bonus for real-time updates
      # but this periodic sync is the SOURCE OF TRUTH
      - name: Get Renovate PRs
        id: get-prs
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-github-app-token.outputs.token }}
          script: |
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            const renovatePRs = pulls.filter(pr => 
              pr.head.ref.startsWith('Garoon-renovate')
            );
            
            const MAX_FILES = 50;
            const prListWithFiles = await Promise.all(
              renovatePRs.map(async (pr) => {
                try {
                  const { data: files } = await github.rest.pulls.listFiles({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: pr.number
                  });
                  
                  const fileList = files.length > MAX_FILES 
                    ? files.slice(0, MAX_FILES).map(f => f.filename).join('\n') + `\n... and ${files.length - MAX_FILES} more files`
                    : files.map(f => f.filename).join('\n');
                  
                  return {
                    number: pr.number,
                    branch: pr.head.ref,
                    title: pr.title,
                    url: pr.html_url,
                    files: fileList,
                    state: pr.state
                  };
                } catch (error) {
                  console.log(`Failed to fetch files for PR #${pr.number}:`, error.message);
                  return {
                    number: pr.number,
                    branch: pr.head.ref,
                    title: pr.title,
                    url: pr.html_url,
                    files: 'Unable to fetch files',
                    state: pr.state
                  };
                }
              })
            );
            
            core.setOutput('pr-list', JSON.stringify(prListWithFiles));
            
            console.log(`Found ${renovatePRs.length} open Renovate PRs to sync`);

      - name: Sync PRs to Kintone (Reconciliation)
        if: always() && steps.get-prs.outputs.pr-list != '[]'
        continue-on-error: true
        working-directory: .github/actions/notify-renovate-to-kintone
        run: |
          pnpm exec ts-node notify.ts reconcile
        env:
          KINTONE_DOMAIN: thuan-ngo.kintone.com
          KINTONE_API_TOKEN: ${{ secrets.KINTONE_RENOVATE_APP_TOKEN }}
          KINTONE_APP_ID: "1"
          PR_LIST_JSON: ${{ steps.get-prs.outputs.pr-list }}
