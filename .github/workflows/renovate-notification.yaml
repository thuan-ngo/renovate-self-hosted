name: Renovate Notification

on:
  pull_request:
    types: [opened, reopened, closed, synchronize]
    branches:
      - main

concurrency:
  group: renovate-notify-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  notify-kintone:
    if: startsWith(github.head_ref, 'Garoon-renovate')
    runs-on: [self-hosted]
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Determine PR status
        id: pr-status
        run: |
          if [ "${{ github.event.pull_request.merged }}" == "true" ]; then
            echo "status=merged" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.action }}" == "closed" ]; then
            echo "status=closed" >> $GITHUB_OUTPUT
          else
            echo "status=open" >> $GITHUB_OUTPUT
          fi

      - name: Get files changed
        id: files-changed
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const { data: files } = await github.rest.pulls.listFiles({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number
              });
              
              const MAX_FILES = 50;
              const fileList = files.length > MAX_FILES 
                ? files.slice(0, MAX_FILES).map(f => f.filename).join('\n') + `\n... and ${files.length - MAX_FILES} more files`
                : files.map(f => f.filename).join('\n');
              
              core.setOutput('files', fileList);
            } catch (error) {
              core.setOutput('files', 'Unable to fetch files');
            }

      - name: Notify to Kintone
        uses: ./.github/actions/notify-renovate-to-kintone
        with:
          kintone-domain: thuan-ngo.kintone.com
          kintone-api-token: ${{ secrets.KINTONE_RENOVATE_APP_TOKEN }}
          app-id: "1"
          branch-name: ${{ github.head_ref }}
          pr-title: ${{ github.event.pull_request.title }}
          pr-status: ${{ steps.pr-status.outputs.status }}
          pr-url: ${{ github.event.pull_request.html_url }}
          files-changed: ${{ steps.files-changed.outputs.files }}
